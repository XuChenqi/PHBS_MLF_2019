# Consumer behavior prediction, based on Taobao data
## Team Member
Name|Student ID|GitHub
---|--|---
Zhang Ping|1901212672|[Parametric3](https://github.com/Parametric3)
Xu Chenqi|1901212653|[XuChenqi](https://github.com/XuChenqi)
Lin Haoru|1901212609|[HalinaLin](https://github.com/HalinaLin)
Luo Chaojing|1901212618|[crystallake27](https://github.com/crystallake27)
## Background
E-commerce has gradually become an essential part of our daily life. In 2019, China's online consumption accounted for more than 25% of total consumption. Under this situation, taking advantage of the big data generated by online transactions, we can analyze and reasonably predict consumer behavior.</p>
Our team obtained Taobao's consumer behavior data from Tianchi, AliCloud, starting from **November 18, 2014** to **December 18, 2014.** Based on that, we derived a series of other features which help interprete the consumer behaviors, and performed corresponding data preprocessing. After that, we comprehensively conducted LR, SVM, Decision Tree, Random Forest. 
## Data
Our data is from Tianchi, AliCloud, starting from November 18, 2014 to December 18, 2014. The original data includ two files. One is about all the users' bahaviors on all the items in that period, inclouding **6 basic indicators**, user id, item id, behavior type (browse, collect, purchase, etc.), user geohash (location), item category and time.</p>
Name|Meaning|Explain
:---:|:---:|:---:
user_id|the unique user identidication|
item_id|the unique item identidication|
behavior_type|the classification of user behavior|browing, collecting, adding into cart and purcahsing, corresponding to 1, 2, 3 and 4 respectively
user_geohash|the location of the user|can be null
item_category|the category of one certain item|
time|time when behaving| precised to hour

For example, **141278390,282725298,1,95jnuqm,5027,2014-11-18 08**.</p>
The other file is about all the items, inclouding **3 basic indicators**, item id, item geohash (location), item category.</p>
Name|Meaning|Explain
:---:|:---:|:---:
item_id|the unique item identidication|
item_geohash|the location of the item|can be null
item_category|the category of one certain item|

For example, **117151719,96ulbnj,7350**.</p>
For detailed data, see our [data](https://disk.pku.edu.cn:443/link/2B3214E55199700FDB7D21C86F93A9E7) in PKU Cloud.
## Overall Analysis
### Problem Type: Classification
**'Prucahse'** correspodning to **'1'**, and **'Not Purchase'** corresponding to **'0'**</p>
Particularity of the problem:
1. The label is not just for one user or one item, but for one user-item pair **(user, item)**, which influence the selection of training set and test set
2. This is cross-sectional problem. For example, for one user-item pair, its label is derived from the bahevior of 18th, while its features are derived from days before 18th. That is because we can only the past to predict the future.
### Days that really matter
Since we will use the information before 18th to predict the user behavior in 18th, the next question is how many days should be considered. Intuitively, the behavior one month ago definetely has nothing to do with whether the user will buy or not. So this actually a hyperparameter that we should decide first, and then find its best value through fine-tuning. Using $\Delta$ to denote it, and we let $\Delta$ = 2 at first.</p>
### Test Set
Three ways to choose test set:</p>
1. ~~All users and all items:~~
![](https://raw.githubusercontent.com/Parametric3/PHBS_MLF_2019/master/Figs/Test_Set_Selection_1.png)
2. ~~Users who have certain behaviors and the items that users has interactions with in the two days before :~~
![](https://raw.githubusercontent.com/Parametric3/PHBS_MLF_2019/master/Figs/Test_Set_Selection_2.png)
3. For each user who was active before, only condider the items that he has interactions with:
<div align="center">
<img src="https://raw.githubusercontent.com/Parametric3/PHBS_MLF_2019/master/Figs/Test_Set_Selection_3.png" height="330" width="450"/>
</div>

### Train Set
The basic rules all the same for train set. Two things to consider:</p>
1. As customary, we set the ratio between the training set and the test set to be 4:1. So since we have choose **(16, 17 | 18)** as the test set (before '|', the features of test set; after '|', the labels of the test set), we need to choose another four group.
2. If we count back from 18th, the abnormal comsumption in 12th, December will distrurb our model greatly, so we need to skip that when choose the train set.

The overall process is shon below, and related data that has been processed is in our [Data](https://github.com/Parametric3/PHBS_MLF_2019/tree/master/Data) folder.
![OveralL Process](https://raw.githubusercontent.com/Parametric3/PHBS_MLF_2019/master/Figs/OveralL_Process.png)
## Feature Generating
All the features can be dicided into two levels:
1. Basic features, which usually involves one indicator in the original file;
2. Interactive features, which involves two or moe original indicators.

And for each feature class, like user features, the features it contains can be divided into three tyoes:
1. Satistic features: Obtained by directly counting the number of certain event.
2. Ratio features: Ratio between two satistic features.
3. Time features: Features that involve time.
### Basic Features
1. User features (Feature type = 1):

Feature name| type | Explaination
---|---|---
1_user_activity|statictic|number of user actions in the two days
1_number_of_items_related|statictic|number of items that the user had interactions with in the two days
1_number_of_browsing_actions|statictic|number of browsing actions in the two days
1_number_of_collecting_actions|statictic|number of collecting actions in the two days
1_number_of_carting_actions|statictic|number of adding into the cart actions in the two days
1_number_of_buying_actions|statictic|number of purchasing actions in the two days
1_behavior_pattern|statictic|1 as dirctly buying, 0 as collecting or adding into cart before buying and -1 as not buying
1_ratio_of_browsing_actions|ratio|ratio between number of browsing actions and number of all actions
1_ratio_of_collecting_actions|ratio|ratio between number of collecting actions and number of all actions
1_ratio_of_carting_actions|ratio|ratio between number of adding into cart actions and number of all actions
1_ratio_of_buying_actions|ratio|ratio between number of purchasing actions and number of all actions
1_conveting_rate|ratio|ratio between number of items finally purchased and number of all items related
1_first_time_online|time|the time lag between first online and the 0 o'clock on the prediction day
1_last_time_online|time|the time lag between last online and the 0 o'clock on the prediction day
1_time_lag|time|the time lag between first online and last time online
1_the_behavior_frequency|time|time lag over the total number of activities

2. Item features (Feature type = 1):
3. Category features (Feature type = 3):

Feature name| type | Explaination
---|---|---
3_number_of_categories_related|statictic|number of categories that user had interaction with
3_category_concentration_rate|ratio|number of items related over number of categories related

4. Geo features (Feature type = 4):

### Interactive Features

## Model Building
### Imbalanced Sample: Up&downsampling</p>
Through statistics, we have a total of 279,525 samples, while the number of samples with the "label=1"(**'Purchase'**) is only 1,529. The ratio of samples with "label=1" and 'label=0' is around 1:190. In order to eliminate the impact of data imbance on the model results, we upscaled the data with "label=1" and also downscaled the data with "label=0" in the training set. In the end, the ratio of samples with "label=1" and "label=0" is around 1:10.</p>
### 1. Lasso Logistic Regression</p>
Use L1 regularization to achieve variable selection</p>
result</p>
### 2. PCA + Logistic Regression
Choose n principle components can explain more than 90% of the variance in the model, then do Logistic Regression</p>
pca gragh</p>
### 3. SVM</p>
### 4. Random Forest--bagging</p>
show important features</p>
### 5. GBRT (Gradient Boost Regression Tree)--boosting</p>
### 6. RF+GBRT</p>
**Combination1**</p>
a. Use RF to train, output is y_rf;</p>
b. Use GBRT to train under y-y_rf;</p>
c. Use the average of a&b when predict.</p>
<div align="center">
<img src="https://raw.githubusercontent.com/Parametric3/PHBS_MLF_2019/master/Figs/RF+GBRT1.png" height="330" width="850"/>
</div>

**Combination2**</p>
a. Use RF to get random features;</p>
b. Use GBRT for those features;</p>
c. Use the average of multiple GBRT outputs when predict.</p>
<div align="center">
<img src="https://raw.githubusercontent.com/Parametric3/PHBS_MLF_2019/master/Figs/RF+GBRT2.png" height="330" width="450"/>
</div>

6. GBRT+LR</p>
Stucture/depth/learning rate/iteration are decided by Gredient Search</p>
<div align="center">
<img src="https://raw.githubusercontent.com/Parametric3/PHBS_MLF_2019/master/Figs/LR+GBRT.png" height="330" width="650"/>
</div>

## Metrics
ROC curve</p>
AUC</p>
## Future Work
1. Introduce interaction terms;</p>
2. Optimize the parameters in the model;</p>
